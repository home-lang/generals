// C&C Generals Zero Hour - Home Port
// Skirmish AI (Computer Player)
//
// Original: AIPlayer.cpp, AIUpdate.cpp (Westwood Studios/EA)
// Ported to Home with modern AI decision making

import basics/allocator
import engine/ecs
import engine/math
import game/unit
import game/building
import game/economy

// AI difficulty levels
enum AIDifficulty {
    Easy
    Medium
    Hard
    Brutal
}

// AI personality types (affects strategy)
enum AIPersonality {
    Balanced    // Mix of everything
    Rusher      // Early aggression
    Turtle      // Defensive, tech up
    Harasser    // Hit and run tactics
    Bomber      // Focus on aircraft
}

// AI state
enum AIState {
    Starting      // Initial base building
    Expanding     // Building economy
    Attacking     // Offensive operations
    Defending     // Under attack
    Recovering    // Rebuilding after losses
    Winning       // Dominating
    Desperate     // Last stand
}

// Build order item
struct BuildOrderItem {
    building_type: BuildingType
    priority: u32
    built: bool
}

// Attack wave
struct AttackWave {
    unit_count: usize
    target_position: Vec3
    is_active: bool
    created_time: f64
}

// AI player instance
struct AIPlayer {
    player_id: u32
    team_id: u32
    difficulty: AIDifficulty
    personality: AIPersonality
    faction: string  // "USA", "China", "GLA"
    state: AIState
    last_state_change: f64
    base_position: Vec3
    base_radius: f32
    owned_unit_count: usize
    owned_building_count: usize
    build_order_count: usize
    current_build_index: usize
    attack_wave_count: usize
    time_since_last_attack: f64
    attack_interval: f64  // Seconds between attacks
    desired_infantry_count: u32
    desired_tank_count: u32
    desired_aircraft_count: u32
    desired_supply_centers: u32
    desired_power: i32
    enemy_threat_level: f32  // 0.0 to 1.0
    is_under_attack: bool
    last_attack_time: f64
    time_since_unit_build: f64
    time_since_building_build: f64
    time_since_tech_upgrade: f64
    allocator: Allocator
}

// Predefined build orders for each faction
fn create_usa_build_order(allocator: Allocator): []BuildOrderItem {
    let build_order = allocator.alloc(BuildOrderItem, 10)

    build_order[0] = BuildOrderItem { building_type: BuildingType.Supply_Center, priority: 1, built: false }
    build_order[1] = BuildOrderItem { building_type: BuildingType.Barracks, priority: 2, built: false }
    build_order[2] = BuildOrderItem { building_type: BuildingType.Supply_Center, priority: 3, built: false }
    build_order[3] = BuildOrderItem { building_type: BuildingType.War_Factory, priority: 4, built: false }
    build_order[4] = BuildOrderItem { building_type: BuildingType.Airfield, priority: 5, built: false }
    build_order[5] = BuildOrderItem { building_type: BuildingType.Strategy_Center, priority: 6, built: false }

    return build_order
}

// AI Manager (manages all AI players)
struct AIManager {
    ai_player_count: usize
    allocator: Allocator
}

// Global AI manager
var g_ai_manager: ?AIManager = null

export fn init_ai(allocator: Allocator) {
    g_ai_manager = AIManager.init(allocator)
}

export fn shutdown_ai() {
    if (g_ai_manager) {
        g_ai_manager.?.deinit()
        g_ai_manager = null
    }
}

export fn create_ai_player(player_id: u32, difficulty: AIDifficulty) {
    if (g_ai_manager) {
        g_ai_manager.?.create_ai_player(player_id, difficulty)
    }
}

export fn update_ai(delta_time: f32, current_time: f64) {
    if (g_ai_manager) {
        g_ai_manager.?.update(delta_time, current_time)
    }
}
