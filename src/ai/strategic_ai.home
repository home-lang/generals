// C&C Generals Zero Hour - Home Port
// Strategic AI (Base Building, Attack Coordination, Defense)
//
// Original: AIStrategicStateUpdate.cpp, BaseBuilder.cpp (Westwood Studios/EA)
// Ported to Home with modern strategic decision making

import basics/allocator
import engine/ecs
import engine/math
import game/unit
import game/building
import game/economy
import ai/pathfinding

// Strategic priority
enum StrategicPriority {
    Economy      // Focus on building economy
    Military     // Focus on military production
    Tech         // Focus on tech upgrades
    Defense      // Focus on defensive structures
    Expansion    // Focus on expanding to new bases
}

// Base location
struct BaseLocation {
    center: Vec3
    radius: f32
    is_main_base: bool
    is_expansion: bool
    supply_dock_position: Vec3
    has_supply_dock: bool
    threat_level: f32
}

// Building placement request
struct BuildingPlacement {
    building_type: BuildingType
    priority: u32
    preferred_position: Vec3
    min_distance_from_base: f32
    max_distance_from_base: f32
    requires_power: bool
    is_defensive: bool
}

// Attack force composition
struct AttackComposition {
    infantry_count: u32
    light_vehicle_count: u32
    heavy_vehicle_count: u32
    aircraft_count: u32
    total_strength: f32
    is_ready: bool
}

// Defensive position
struct DefensivePosition {
    position: Vec3
    importance: f32  // 0.0 to 1.0
    has_defense: bool
    defense_type: BuildingType
    threat_direction: Vec3  // Direction enemies likely to come from
}

// Tech progression stage
enum TechStage {
    Early      // Basic units only
    Mid        // Advanced units available
    Late       // All units + superweapons
}

// Strategic AI manager
struct StrategicAI {
    player_id: u32
    base_count: usize
    main_base: Vec3
    placement_grid: PathfindingGrid  // Reuse pathfinding grid for placement
    placement_count: usize
    current_priority: StrategicPriority
    tech_stage: TechStage
    target_supply_centers: u32
    target_power_plants: u32
    supply_centers_built: u32
    power_plants_built: u32
    target_barracks_count: u32
    target_factory_count: u32
    target_airfield_count: u32
    defensive_position_count: usize
    perimeter_defense_count: u32
    min_attack_strength: f32
    preferred_attack_composition: AttackComposition
    expansion_interval: f64  // Seconds between expansion attempts
    time_since_last_expansion: f64
    max_expansions: u32
    allocator: Allocator
}

// Attack plan for coordinated strikes
struct AttackPlan {
    wave_1_delay: f32
    wave_2_delay: f32
    wave_3_delay: f32
    target_position: Vec3
    retreat_threshold: f32
}

// Attack composition helper
impl AttackComposition {
    fn init(): AttackComposition {
        return AttackComposition {
            infantry_count: 0
            light_vehicle_count: 0
            heavy_vehicle_count: 0
            aircraft_count: 0
            total_strength: 0.0
            is_ready: false
        }
    }

    fn get_total_units(&self): u32 {
        return self.infantry_count +
               self.light_vehicle_count +
               self.heavy_vehicle_count +
               self.aircraft_count
    }
}

// Build order templates for each faction
fn create_usa_strategic_build_order(ai: *StrategicAI) {
    // USA opening build order
    ai.plan_building_placement(BuildingType.Supply_Center, 10, false)
    ai.plan_building_placement(BuildingType.Barracks, 9, false)
    ai.plan_building_placement(BuildingType.Supply_Center, 8, false)
    ai.plan_building_placement(BuildingType.War_Factory, 7, false)
    ai.plan_building_placement(BuildingType.Patriot_Missile, 6, true)
    ai.plan_building_placement(BuildingType.Patriot_Missile, 5, true)
    ai.plan_building_placement(BuildingType.Airfield, 4, false)
}

fn create_china_strategic_build_order(ai: *StrategicAI) {
    // China opening build order
    ai.plan_building_placement(BuildingType.Supply_Center_China, 10, false)
    ai.plan_building_placement(BuildingType.Barracks_China, 9, false)
    ai.plan_building_placement(BuildingType.Supply_Center_China, 8, false)
    ai.plan_building_placement(BuildingType.War_Factory_China, 7, false)
    ai.plan_building_placement(BuildingType.Gattling_Cannon, 6, true)
    ai.plan_building_placement(BuildingType.Propaganda_Center, 5, false)
}

fn create_gla_strategic_build_order(ai: *StrategicAI) {
    // GLA opening build order
    ai.plan_building_placement(BuildingType.Supply_Stash, 10, false)
    ai.plan_building_placement(BuildingType.Barracks_GLA, 9, false)
    ai.plan_building_placement(BuildingType.Supply_Stash, 8, false)
    ai.plan_building_placement(BuildingType.Arms_Dealer, 7, false)
    ai.plan_building_placement(BuildingType.Tunnel_Network, 6, false)
    ai.plan_building_placement(BuildingType.Stinger_Site, 5, true)
}

// Global strategic AI manager
var g_strategic_ai: ?StrategicAI = null

export fn init_strategic_ai(allocator: Allocator, player_id: u32, main_base: Vec3) {
    g_strategic_ai = StrategicAI.init(allocator, player_id, main_base)

    // Identify defensive positions
    g_strategic_ai.?.identify_defensive_positions()
}

export fn shutdown_strategic_ai() {
    if (g_strategic_ai) {
        g_strategic_ai.?.deinit()
        g_strategic_ai = null
    }
}

export fn update_strategic_ai(delta_time: f32) {
    if (g_strategic_ai) {
        g_strategic_ai.?.update(delta_time)
    }
}

export fn request_building_placement(building_type: BuildingType, priority: u32, is_defensive: bool) {
    if (g_strategic_ai) {
        g_strategic_ai.?.plan_building_placement(building_type, priority, is_defensive)
    }
}

export fn get_attack_composition(target_strength: f32): AttackComposition {
    if (g_strategic_ai) {
        return g_strategic_ai.?.calculate_attack_composition(target_strength)
    }

    return AttackComposition.init()
}
