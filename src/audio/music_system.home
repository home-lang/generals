// C&C Generals Zero Hour - Home Port
// Music System (Dynamic soundtrack)
//
// Original: Music.ini, MusicManager.cpp (Westwood Studios/EA)
// Music by Frank Klepacki and Bill Brown
//
// Music file locations (from EA's original data files):
// All music located in: Data/Audio/Music/
//
// Main Menu Music:
// - Menu.mp3
//
// USA Faction Themes:
// - USA1.mp3 - "USA Theme" (Frank Klepacki)
// - USA2.mp3 - "Cavalry Approaching"
// - USA3.mp3 - "War Machine"
// - USA4.mp3 - "Tank Rush"
// - USA5.mp3 - "Battle"
//
// China Faction Themes:
// - China1.mp3 - "China Theme" (Frank Klepacki)
// - China2.mp3 - "Red Army"
// - China3.mp3 - "Dragon Rising"
// - China4.mp3 - "March to War"
//
// GLA Faction Themes:
// - GLA1.mp3 - "GLA Theme" (Frank Klepacki)
// - GLA2.mp3 - "Desert Combat"
// - GLA3.mp3 - "Guerrilla"
// - GLA4.mp3 - "Sandstorm"
//
// Combat Music (plays during battles):
// - Battle1.mp3
// - Battle2.mp3
// - Battle3.mp3
// - Combat.mp3
// - Conflict.mp3
//
// Victory/Defeat Music:
// - Victory.mp3
// - Defeat.mp3
//
// Credits Music:
// - Credits.mp3

import basics/allocator
import audio/audio_engine

// Music track
struct MusicTrack {
    name: string
    filename: string
    faction: string  // "USA", "China", "GLA", "Neutral"
    mood: MusicMood
    duration: f32  // Seconds
}

// Music mood (determines when to play)
enum MusicMood {
    Menu
    Ambient      // Peaceful, exploring
    Combat       // During battle
    Victory
    Defeat
    Credits
}

// Music state
enum MusicState {
    Stopped
    Playing
    FadingOut
    FadingIn
}

// Music manager
struct MusicManager {
    track_count: usize
    usa_track_count: usize
    china_track_count: usize
    gla_track_count: usize
    neutral_track_count: usize
    combat_track_count: usize
    current_handle: AudioHandle
    current_state: MusicState
    current_faction: string
    current_mood: MusicMood
    music_volume: f32
    is_enabled: bool
    shuffle: bool
    fade_duration: f32
    fade_timer: f32
    allocator: Allocator
}

// Helper functions

fn random_range(min: usize, max: usize): usize {
    // TODO: Proper random
    return min
}

fn clamp(value: f32, min: f32, max: f32): f32 {
    if (value < min) { return min }
    if (value > max) { return max }
    return value
}

// Global music manager
var g_music_manager: ?MusicManager = null

export fn init_music_system(allocator: Allocator) {
    g_music_manager = MusicManager.init(allocator)
    g_music_manager.?.register_all_tracks()
}

export fn shutdown_music_system() {
    if (g_music_manager) {
        g_music_manager.?.deinit()
        g_music_manager = null
    }
}

export fn update_music(delta_time: f32) {
    if (g_music_manager) {
        g_music_manager.?.update(delta_time)
    }
}

export fn music_set_faction(faction: string) {
    if (g_music_manager) {
        g_music_manager.?.set_faction(faction)
    }
}

export fn music_play_menu() {
    if (g_music_manager) {
        g_music_manager.?.play_menu_music()
    }
}

export fn music_play_combat() {
    if (g_music_manager) {
        g_music_manager.?.play_combat_music()
    }
}

export fn music_play_ambient() {
    if (g_music_manager) {
        g_music_manager.?.play_ambient_music()
    }
}

export fn music_play_victory() {
    if (g_music_manager) {
        g_music_manager.?.play_victory_music()
    }
}

export fn music_play_defeat() {
    if (g_music_manager) {
        g_music_manager.?.play_defeat_music()
    }
}

export fn music_set_enabled(enabled: bool) {
    if (g_music_manager) {
        g_music_manager.?.set_enabled(enabled)
    }
}

export fn music_set_volume(volume: f32) {
    if (g_music_manager) {
        g_music_manager.?.set_volume(volume)
    }
}
