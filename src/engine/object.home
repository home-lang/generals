// Object system for C&C Generals Zero Hour
// Based on Thyme's object.h - Complete game objects combining all modules
// Written in Home language

import thing
import kindof
import locomotor
import weapon
import body
import player

// Object status flags
enum ObjectStatus {
    DESTROYED = 0,
    SOLD = 1,
    UNDER_CONSTRUCTION = 2,
    ATTACKING = 3,
    MOVING = 4,
    DAMAGED = 5,
    REALLYDAMAGED = 6,
    GARRISONED = 7,
    POWERED = 8,
    DISABLED = 9,
    AFLAME = 10,
    AIRBORNE_TARGET = 11,
    СЕЛECTABLE = 12,
    INVISIBLE = 13,
    DETECTED = 14,
}

// Object - Complete game object combining all systems
struct Object {
    object_id: i32,
    thing: thing::Thing,
    owner_player_id: i32,
    status_bits: i32,  // Bitfield of ObjectStatus
    body: body::Body?,
    locomotor: locomotor::Locomotor?,
    weapon_set: weapon::WeaponSet?,
    velocity: thing::Vec3,
    target_position: thing::Vec3?,
    target_object_id: i32,
    vision_range: f64,
    shroud_clearing_range: f64,
    construction_percent: f64,
    is_being_built: bool,
    garrisoned_units: Vec<i32>,  // Object IDs
    garrison_capacity: i32,
    production_queue: Vec<i32>,  // What's being built
    experience_points: i32,
    veterancy_level: i32,
        thing: thing::Thing,
        owner_player_id: i32
            object_id: object_id,
            thing: thing,
            owner_player_id: owner_player_id,
            status_bits: 0,
            body: null,
            locomotor: null,
            weapon_set: null,
            velocity: thing::Vec3::zero(),
            target_position: null,
            vision_range: 150.0,
            shroud_clearing_range: 150.0,
            construction_percent: 0.0,
            is_being_built: false,
            garrisoned_units: Vec::new(),
            garrison_capacity: 0,
            production_queue: Vec::new(),
            experience_points: 0,
            veterancy_level: 0,
}

// ObjectManager - Manages all objects in the game
struct ObjectManager {
    objects: Vec<Object>,
    next_id: i32,
}

// Tests
test "Object: basic creation" {
    let template = thing::create_basic_template(
        "Ranger",
        kindof::kindof_mask_infantry(),
        5.0,
        10.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    assert obj.get_id() == 0
    assert obj.owner_player_id == 0
    assert obj.is_infantry()
}

test "Object: position and movement" {
    let template = thing::create_basic_template(
        "Tank",
        kindof::kindof_mask_vehicle(),
        10.0,
        15.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    obj.set_position(thing::Vec3::init(100.0, 100.0, 0.0))
    let pos = obj.get_position()
    assert pos.x == 100.0
    assert pos.y == 100.0
}

test "Object: status flags" {
    let template = thing::create_basic_template(
        "Building",
        kindof::kindof_mask_structure(),
        20.0,
        30.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    assert !obj.get_status(ObjectStatus::DAMAGED)

    obj.set_status(ObjectStatus::DAMAGED, true)
    assert obj.get_status(ObjectStatus::DAMAGED)

    obj.set_status(ObjectStatus::DAMAGED, false)
    assert !obj.get_status(ObjectStatus::DAMAGED)
}

test "Object: health and damage" {
    let template = thing::create_basic_template(
        "Tank",
        kindof::kindof_mask_vehicle(),
        10.0,
        15.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    obj.body = body::Body::init(1000.0)

    assert obj.get_health() == 1000.0
    assert obj.get_health_percentage() == 100.0

    obj.take_damage(300.0, 1, 0)
    assert obj.get_health() == 700.0
    assert !obj.is_destroyed()

    obj.take_damage(700.0, 1, 0)
    assert obj.is_destroyed()
}

test "Object: construction" {
    let template = thing::create_basic_template(
        "Barracks",
        kindof::kindof_mask_structure(),
        30.0,
        40.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    obj.start_construction()
    assert obj.is_being_built
    assert obj.construction_percent == 0.0

    obj.update_construction(50.0)
    assert obj.construction_percent == 50.0
    assert obj.is_being_built

    obj.update_construction(50.0)
    assert obj.construction_percent == 100.0
    assert !obj.is_being_built
}

test "Object: garrison" {
    let template = thing::create_basic_template(
        "Bunker",
        kindof::kindof_mask_structure(),
        20.0,
        20.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    obj.garrison_capacity = 5

    assert obj.can_garrison()
    assert obj.garrison_unit(100)
    assert obj.garrison_unit(101)

    assert obj.garrisoned_units.count() == 2

    let units = obj.eject_garrison()
    assert units.count() == 2
    assert obj.garrisoned_units.count() == 0
}

test "Object: experience and veterancy" {
    let template = thing::create_basic_template(
        "Tank",
        kindof::kindof_mask_vehicle(),
        10.0,
        15.0
    )
    let thing = thing::Thing::init(template)
    let obj = Object::init(0, thing, 0)

    assert obj.get_veterancy_level() == 0

    obj.award_experience(100)
    assert obj.get_veterancy_level() == 1

    obj.award_experience(200)
    assert obj.get_veterancy_level() == 2
}

test "ObjectManager: create and retrieve" {
    let manager = ObjectManager::init()

    let template = thing::create_basic_template(
        "Ranger",
        kindof::kindof_mask_infantry(),
        5.0,
        10.0
    )
    let thing = thing::Thing::init(template)

    let obj = manager.create_object(thing, 0)
    assert obj.get_id() == 0

    let retrieved = manager.get_object(0)?
    assert retrieved.get_id() == 0
}

test "ObjectManager: filter by player" {
    let manager = ObjectManager::init()

    let template = thing::create_basic_template(
        "Unit",
        kindof::kindof_mask_infantry(),
        5.0,
        10.0
    )

    manager.create_object(thing::Thing::init(template), 0)
    manager.create_object(thing::Thing::init(template), 0)
    manager.create_object(thing::Thing::init(template), 1)

    let player0_objects = manager.get_objects_for_player(0)
    assert player0_objects.count() == 2

    let player1_objects = manager.get_objects_for_player(1)
    assert player1_objects.count() == 1
}

test "ObjectManager: remove object" {
    let manager = ObjectManager::init()

    let template = thing::create_basic_template(
        "Unit",
        kindof::kindof_mask_infantry(),
        5.0,
        10.0
    )

    let obj = manager.create_object(thing::Thing::init(template), 0)
    assert manager.get_object_count() == 1

    manager.remove_object(obj.get_id())
    assert manager.get_object_count() == 0
}
