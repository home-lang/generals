// Fog of War system for C&C Generals Zero Hour
// Visibility tracking, shroud, explored areas
// Written in Home language

// Visibility state for tiles
enum VisibilityState {
    UNEXPLORED = 0,  // Never seen (black)
    EXPLORED = 1,    // Seen before (dark gray)
    VISIBLE = 2,     // Currently visible
}

// Fog of war tile
struct FogTile {
    visibility: VisibilityState,
    last_update_frame: i32,
}

// Vision provider (unit/building)
struct VisionProvider {
    id: i32,
    position_x: f64,
    position_y: f64,
    vision_range: f64,
    is_active: bool,
    owner_player_id: i32,
}

// Fog of war grid
struct FogOfWarGrid {
    width: i32,
    height: i32,
    tile_size: f64,
    tiles: Vec<Vec<FogTile>>,
    current_frame: i32,
}

// Fog of war manager per player
struct FogOfWarManager {
    grids: Vec<FogOfWarGrid>,
    vision_providers: Vec<VisionProvider>,
    player_id: i32,
    update_interval: f64,
    time_since_update: f64,
}

// Shared vision between team members
struct TeamVision {
    team_id: i32,
    managers: Vec<FogOfWarManager>,
    shared_vision_enabled: bool,
}

// Helper function
fn sqrt(x: f64): f64 {
    return x ** 0.5
}

// Tests
test "FogTile: init" {
    let tile = FogTile::init()

    assert tile.visibility == VisibilityState::UNEXPLORED
    assert !tile.is_visible()
    assert !tile.is_explored()
}

test "FogTile: reveal and hide" {
    let tile = FogTile::init()

    tile.reveal(1)
    assert tile.is_visible()
    assert tile.is_explored()

    tile.hide(2)
    assert !tile.is_visible()
    assert tile.is_explored()
}

test "VisionProvider: init" {
    let provider = VisionProvider::init(0, 100.0, 100.0, 50.0, 1)

    assert provider.id == 0
    assert provider.vision_range == 50.0
    assert provider.is_active
}

test "VisionProvider: update position" {
    let provider = VisionProvider::init(0, 0.0, 0.0, 50.0, 1)

    provider.update_position(100.0, 100.0)
    assert provider.position_x == 100.0
    assert provider.position_y == 100.0
}

test "VisionProvider: set active" {
    let provider = VisionProvider::init(0, 0.0, 0.0, 50.0, 1)

    provider.set_active(false)
    assert !provider.is_active
}

test "FogOfWarGrid: init" {
    let grid = FogOfWarGrid::init(100, 100, 10.0)

    assert grid.width == 100
    assert grid.height == 100
    assert grid.tile_size == 10.0
}

test "FogOfWarGrid: get tile" {
    let grid = FogOfWarGrid::init(10, 10, 10.0)

    let tile = grid.get_tile(5, 5)?
    assert !tile.is_visible()

    let invalid = grid.get_tile(100, 100)
    assert invalid == null
}

test "FogOfWarGrid: reveal and hide tile" {
    let grid = FogOfWarGrid::init(10, 10, 10.0)

    grid.reveal_tile(5, 5)
    assert grid.is_visible(5, 5)

    grid.hide_tile(5, 5)
    assert !grid.is_visible(5, 5)
    assert grid.is_explored(5, 5)
}

test "FogOfWarGrid: world to tile" {
    let grid = FogOfWarGrid::init(100, 100, 10.0)

    let (tx, ty) = grid.world_to_tile(25.0, 35.0)
    assert tx == 2
    assert ty == 3
}

test "FogOfWarGrid: reveal circle" {
    let grid = FogOfWarGrid::init(20, 20, 10.0)

    grid.reveal_circle(100.0, 100.0, 30.0)

    assert grid.is_visible(10, 10)  // Center
    assert grid.is_visible(11, 10)  // Adjacent
    assert grid.is_visible(9, 10)   // Adjacent
}

test "FogOfWarGrid: reveal all" {
    let grid = FogOfWarGrid::init(5, 5, 10.0)

    grid.reveal_all()

    assert grid.is_visible(0, 0)
    assert grid.is_visible(4, 4)
    assert grid.get_visibility_percentage() == 100.0
}

test "FogOfWarGrid: hide all" {
    let grid = FogOfWarGrid::init(5, 5, 10.0)

    grid.reveal_all()
    grid.hide_all()

    assert !grid.is_visible(2, 2)
    assert grid.is_explored(2, 2)
}

test "FogOfWarGrid: advance frame" {
    let grid = FogOfWarGrid::init(10, 10, 10.0)

    assert grid.current_frame == 0

    grid.advance_frame()
    assert grid.current_frame == 1
}

test "FogOfWarGrid: visibility percentage" {
    let grid = FogOfWarGrid::init(10, 10, 10.0)

    assert grid.get_visibility_percentage() == 0.0

    grid.reveal_all()
    assert grid.get_visibility_percentage() == 100.0
}

test "FogOfWarManager: init" {
    let manager = FogOfWarManager::init(0, 100, 100, 10.0)

    assert manager.player_id == 0
    assert manager.get_provider_count() == 0
}

test "FogOfWarManager: add and remove providers" {
    let manager = FogOfWarManager::init(0, 100, 100, 10.0)

    let provider = VisionProvider::init(100, 50.0, 50.0, 30.0, 0)
    manager.add_vision_provider(provider)

    assert manager.get_provider_count() == 1

    manager.remove_vision_provider(100)
    assert manager.get_provider_count() == 0
}

test "FogOfWarManager: update provider position" {
    let manager = FogOfWarManager::init(0, 100, 100, 10.0)

    let provider = VisionProvider::init(100, 0.0, 0.0, 30.0, 0)
    manager.add_vision_provider(provider)

    manager.update_provider_position(100, 100.0, 100.0)

    for p in manager.vision_providers {
        if (p.id == 100) {
            assert p.position_x == 100.0
        }
    }
}

test "FogOfWarManager: recalculate visibility" {
    let manager = FogOfWarManager::init(0, 100, 100, 10.0)

    let provider = VisionProvider::init(100, 50.0, 50.0, 30.0, 0)
    manager.add_vision_provider(provider)

    manager.recalculate_visibility()

    assert manager.is_position_visible(50.0, 50.0)
}

test "FogOfWarManager: is position visible" {
    let manager = FogOfWarManager::init(0, 100, 100, 10.0)

    let provider = VisionProvider::init(100, 50.0, 50.0, 30.0, 0)
    manager.add_vision_provider(provider)

    manager.recalculate_visibility()

    assert manager.is_position_visible(50.0, 50.0)
    assert !manager.is_position_visible(500.0, 500.0)
}

test "FogOfWarManager: reveal all" {
    let manager = FogOfWarManager::init(0, 10, 10, 10.0)

    manager.reveal_all()

    assert manager.is_position_visible(50.0, 50.0)
    assert manager.get_explored_percentage() == 100.0
}

test "FogOfWarManager: update with interval" {
    let manager = FogOfWarManager::init(0, 100, 100, 10.0)
    manager.update_interval = 1.0

    manager.update(0.5)
    assert manager.time_since_update == 0.5

    manager.update(0.6)
    assert manager.time_since_update < 0.5  // Reset after recalculation
}

test "TeamVision: init" {
    let team = TeamVision::init(1)

    assert team.team_id == 1
    assert team.shared_vision_enabled
}

test "TeamVision: add managers" {
    let team = TeamVision::init(1)

    let manager1 = FogOfWarManager::init(0, 100, 100, 10.0)
    let manager2 = FogOfWarManager::init(1, 100, 100, 10.0)

    team.add_manager(manager1)
    team.add_manager(manager2)

    assert team.managers.count() == 2
}

test "TeamVision: shared visibility" {
    let team = TeamVision::init(1)

    let manager1 = FogOfWarManager::init(0, 100, 100, 10.0)
    let provider = VisionProvider::init(100, 50.0, 50.0, 30.0, 0)
    manager1.add_vision_provider(provider)
    manager1.recalculate_visibility()

    team.add_manager(manager1)

    assert team.is_position_visible_to_team(50.0, 50.0)
}

test "TeamVision: disable shared vision" {
    let team = TeamVision::init(1)

    team.disable_shared_vision()
    assert !team.shared_vision_enabled

    let manager = FogOfWarManager::init(0, 100, 100, 10.0)
    team.add_manager(manager)

    assert !team.is_position_visible_to_team(50.0, 50.0)
}
