// World/Map/Game State system for C&C Generals Zero Hour
// Based on Thyme's gamelogic.h and world.h
// Written in Home language

import player
import thing

// Game difficulty
enum GameDifficulty {
    EASY = 0,
    NORMAL = 1,
    HARD = 2,
    BRUTAL = 3,
}

// Game mode
enum GameMode {
    SINGLEPLAYER = 0,
    SKIRMISH = 1,
    MULTIPLAYER = 2,
    REPLAY = 3,
}

// Weather types
enum WeatherType {
    NORMAL = 0,
    SNOWY = 1,
    RAINY = 2,
    SANDSTORM = 3,
}

// Time of day
enum TimeOfDay {
    MORNING = 0,
    AFTERNOON = 1,
    EVENING = 2,
    NIGHT = 3,
}

// Map data
struct Map {
    name: string,
    description: string,
    width: i32,           // In cells
    height: i32,          // In cells
    cell_size: f64,     // World units per cell
    player_count: i32,
    is_multiplayer: bool,
    heightmap: Vec<f64>,
    texture_indices: Vec<i32>,
    weather: WeatherType,
    time_of_day: TimeOfDay,
}

// Game state
struct GameState {
    mode: GameMode,
    difficulty: GameDifficulty,
    is_paused: bool,
    is_game_over: bool,
    winning_player_id: i32,
    current_frame: i32,
    game_time_seconds: f64,
    delta_time: f64,
    map: Map,
    player_manager: player::PlayerManager,
    next_object_id: i32,
    starting_money: f64,
    fog_of_war_enabled: bool,
    allow_cheats: bool,
    build_time_multiplier: f64,
}

// Game session - Top-level container
struct GameSession {
    state: GameState,
    is_active: bool,
}

// Skirmish game setup
struct SkirmishSetup {
    map_name: string,
    player_count: i32,
    starting_money: f64,
    build_speed: f64,
    fog_of_war: bool,
    allow_cheats: bool,
}

// Tests
test "Map: init and dimensions" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)

    assert map.width == 100
    assert map.height == 100
    assert map.get_world_width() == 1000.0
    assert map.get_world_height() == 1000.0
}

test "Map: height manipulation" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)

    assert map.get_height_at(50, 50) == 0.0

    map.set_height_at(50, 50, 100.0)
    assert map.get_height_at(50, 50) == 100.0
}

test "Map: coordinate conversion" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)

    let (cell_x, cell_y) = map.world_to_cell(55.0, 75.0)
    assert cell_x == 5
    assert cell_y == 7

    let (world_x, world_y) = map.cell_to_world(5, 7)
    assert world_x == 55.0
    assert world_y == 75.0
}

test "Map: valid cell check" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)

    assert map.is_valid_cell(50, 50)
    assert map.is_valid_cell(0, 0)
    assert map.is_valid_cell(99, 99)
    assert !map.is_valid_cell(-1, 50)
    assert !map.is_valid_cell(50, 100)
}

test "GameState: init and update" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let state = GameState::init(map, GameMode::SKIRMISH)

    assert state.current_frame == 0
    assert state.game_time_seconds == 0.0
    assert !state.is_game_over

    state.update()
    assert state.current_frame == 1
}

test "GameState: pause and resume" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let state = GameState::init(map, GameMode::SKIRMISH)

    assert !state.is_paused

    state.pause()
    assert state.is_paused
    assert !state.is_game_active()

    state.update()
    assert state.current_frame == 0  // No update while paused

    state.resume()
    assert !state.is_paused
    assert state.is_game_active()

    state.update()
    assert state.current_frame == 1
}

test "GameState: object ID generation" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let state = GameState::init(map, GameMode::SKIRMISH)

    let id1 = state.get_next_object_id()
    let id2 = state.get_next_object_id()
    let id3 = state.get_next_object_id()

    assert id1 == 0
    assert id2 == 1
    assert id3 == 2
}

test "GameState: victory conditions - single survivor" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let state = GameState::init(map, GameMode::SKIRMISH)

    let player1 = player::Player::init(0, "Player 1", player::PlayerType::HUMAN, player::FactionType::USA, 0)
    let player2 = player::Player::init(1, "Player 2", player::PlayerType::COMPUTER, player::FactionType::CHINA, 1)

    state.add_player(player1)
    state.add_player(player2)

    assert !state.is_game_over

    // Player 2 is defeated
    player2.set_defeated(true)

    state.check_victory_conditions()
    assert state.is_game_over
    assert state.winning_player_id == 0
}

test "GameState: victory conditions - team victory" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let state = GameState::init(map, GameMode::SKIRMISH)

    // Team 0: Players 0, 1
    // Team 1: Player 2
    let player1 = player::Player::init(0, "Player 1", player::PlayerType::HUMAN, player::FactionType::USA, 0)
    let player2 = player::Player::init(1, "Player 2", player::PlayerType::HUMAN, player::FactionType::USA, 0)
    let player3 = player::Player::init(2, "Player 3", player::PlayerType::COMPUTER, player::FactionType::CHINA, 1)

    state.add_player(player1)
    state.add_player(player2)
    state.add_player(player3)

    // Player 3 defeated
    player3.set_defeated(true)

    state.check_victory_conditions()
    assert state.is_game_over
}

test "GameState: starting money" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let state = GameState::init(map, GameMode::SKIRMISH)
    state.starting_money = 5000.0

    let player = player::Player::init(0, "Player 1", player::PlayerType::HUMAN, player::FactionType::USA, 0)
    state.add_player(player)

    assert player.get_money() == 5000.0
}

test "GameSession: start and stop" {
    let map = HashMap::init("TestMap", 100, 100, 10.0)
    let session = GameSession::init(map, GameMode::SKIRMISH)

    assert !session.is_active

    session.start()
    assert session.is_active

    session.update()
    assert session.state.current_frame == 1

    session.stop()
    assert !session.is_active

    session.update()
    assert session.state.current_frame == 1  // No update when stopped
}

test "SkirmishSetup: default settings" {
    let setup = SkirmishSetup::default()

    assert setup.player_count == 2
    assert setup.starting_money == 10000.0
    assert setup.build_speed == 1.0
    assert setup.fog_of_war
}

test "SkirmishSetup: create session" {
    let setup = SkirmishSetup::default()
    setup.starting_money = 15000.0
    setup.fog_of_war = false

    let session = setup.create_session()

    assert session.state.starting_money == 15000.0
    assert !session.state.fog_of_war_enabled
    assert session.state.mode == GameMode::SKIRMISH
}
