// Hierarchical Pathfinding A* (HPA*) for C&C Generals
// Advanced pathfinding for large maps with many units
// Written in Home language

// HPA* divides the map into clusters and creates abstract graphs
// This allows very fast pathfinding for long distances

// Cluster - A region of the map
struct Cluster {
    id: i32,
    min_x: i32,
    min_y: i32,
    max_x: i32,
    max_y: i32,
    entrances: Vec<Entrance>,
}

// Entrance - Connection between two clusters
struct Entrance {
    id: i32,
    cluster1_id: i32,
    cluster2_id: i32,
    positions: Vec<(Int, Int)>,  // Cells in the entrance
}

// Abstract node - Represents an entrance in the abstract graph
struct AbstractNode {
    id: i32,
    entrance_id: i32,
    cluster_id: i32,
    connections: Vec<AbstractEdge>,
}

// Abstract edge - Connection between abstract nodes
struct AbstractEdge {
    to_node_id: i32,
    cost: f64,
    level: i32,  // Hierarchy level (0 = lowest, intra-cluster)
}

// HPA* Grid
struct HPAGrid {
    width: i32,
    height: i32,
    cluster_size: i32,
    clusters: Vec<Cluster>,
    entrances: Vec<Entrance>,
    abstract_nodes: Vec<AbstractNode>,
    next_entrance_id: i32,
    next_node_id: i32,
}

// Helper functions
fn min(a: i32, b: i32): i32 {
    if (a < b) { return a } else { return b }
}

fn abs(x: i32): i32 {
    if (x < 0) { return -x } else { return x }
}

fn sqrt(x: f64): f64 {
    // Simplified sqrt
    return x ** 0.5
}

// Tests
test "Cluster: contains check" {
    let cluster = Cluster::init(0, 0, 0, 10, 10)

    assert cluster.contains(5, 5)
    assert cluster.contains(0, 0)
    assert cluster.contains(9, 9)
    assert !cluster.contains(10, 10)
    assert !cluster.contains(-1, 5)
}

test "Cluster: get center" {
    let cluster = Cluster::init(0, 0, 0, 10, 10)
    let (cx, cy) = cluster.get_center()

    assert cx == 5
    assert cy == 5
}

test "Entrance: add positions" {
    let entrance = Entrance::init(0, 0, 1)

    entrance.add_position(10, 5)
    entrance.add_position(10, 6)
    entrance.add_position(10, 7)

    assert entrance.get_width() == 3
    assert entrance.center.1 == 6  // Average y
}

test "AbstractNode: connections" {
    let node = AbstractNode::init(0, 0, 0, (5, 5))

    let edge = AbstractEdge::init(1, 10.0, 1)
    node.add_connection(edge)

    assert node.connections.count() == 1
}

test "HPAGrid: build clusters" {
    let grid = HPAGrid::init(100, 100, 10)

    // Should create 10x10 = 100 clusters
    assert grid.clusters.count() == 100
}

test "HPAGrid: find cluster" {
    let grid = HPAGrid::init(100, 100, 10)

    let cluster = grid.find_cluster(15, 25)?
    assert cluster.id >= 0
    assert cluster.contains(15, 25)
}

test "HPAGrid: cluster coverage" {
    let grid = HPAGrid::init(50, 50, 10)

    // Every cell should be in exactly one cluster
    for y in 0..50 {
        for x in 0..50 {
            let cluster = grid.find_cluster(x, y)
            assert cluster != null
        }
    }
}

test "AbstractEdge: init" {
    let edge = AbstractEdge::init(5, 15.0, 1)

    assert edge.to_node_id == 5
    assert edge.cost == 15.0
    assert edge.level == 1
}
