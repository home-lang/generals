// Main game loop for C&C Generals Zero Hour
// Written in Home language

import world
import player
import object
import production
import ai

// Game loop - orchestrates all systems
struct GameLoop {
    session: world::GameSession,
    object_manager: object::ObjectManager,
    production_manager: production::ProductionManager,
    ai_brains: Vec<ai::AIBrain>,
    target_fps: i32,
    frame_time: f64,
    accumulator: f64,
}

// Tests
test "GameLoop: init" {
    let map = world::HashMap::init("TestMap", 100, 100, 10.0)
    let session = world::GameSession::init(map, world::GameMode::SKIRMISH)
    let game_loop = GameLoop::init(session)

    assert game_loop.target_fps == 60
    assert !game_loop.is_paused()
}

test "GameLoop: start and update" {
    let map = world::HashMap::init("TestMap", 100, 100, 10.0)
    let session = world::GameSession::init(map, world::GameMode::SKIRMISH)
    let game_loop = GameLoop::init(session)

    game_loop.start()
    assert game_loop.session.is_active

    let state_before = game_loop.get_state()
    let frame_before = state_before.current_frame

    game_loop.update(1.0 / 60.0)

    let state_after = game_loop.get_state()
    assert state_after.current_frame > frame_before
}

test "GameLoop: pause and resume" {
    let map = world::HashMap::init("TestMap", 100, 100, 10.0)
    let session = world::GameSession::init(map, world::GameMode::SKIRMISH)
    let game_loop = GameLoop::init(session)

    game_loop.start()
    game_loop.pause()
    assert game_loop.is_paused()

    let state = game_loop.get_state()
    let frame_paused = state.current_frame

    game_loop.update(1.0)
    assert state.current_frame == frame_paused  // No update while paused

    game_loop.resume()
    assert !game_loop.is_paused()
}

test "GameLoop: AI players" {
    let map = world::HashMap::init("TestMap", 100, 100, 10.0)
    let session = world::GameSession::init(map, world::GameMode::SKIRMISH)
    let game_loop = GameLoop::init(session)

    game_loop.add_ai_player(1, ai::AIPersonality::AGGRESSIVE, ai::AIDifficulty::HARD)
    game_loop.add_ai_player(2, ai::AIPersonality::DEFENSIVE, ai::AIDifficulty::MEDIUM)

    assert game_loop.ai_brains.count() == 2
}
