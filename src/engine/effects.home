// Effects system for C&C Generals Zero Hour
// Visual effects, decals, projectile trails, explosions
// Written in Home language

// Effect types
enum EffectType {
    EXPLOSION = 0,
    SMOKE = 1,
    FIRE = 2,
    PROJECTILE_TRAIL = 3,
    MUZZLE_FLASH = 4,
    IMPACT = 5,
    DEBRIS = 6,
    WEATHER = 7,
    BEAM = 8,
    SHOCKWAVE = 9,
}

// Effect lifecycle
enum EffectLifecycle {
    SPAWNING = 0,
    ACTIVE = 1,
    FADING = 2,
    DEAD = 3,
}

// Single effect instance
struct Effect {
    id: i32,
    effect_type: EffectType,
    lifecycle: EffectLifecycle,
    position: Vec3,
    velocity: Vec3,
    scale: f64,
    rotation: f64,
    age: f64,
    lifetime: f64,
    alpha: f64,
}

// Decal for ground marks
struct Decal {
    id: i32,
    position: Vec3,
    size: f64,
    rotation: f64,
    alpha: f64,
    texture_name: string,
    age: f64,
    lifetime: f64,
}

// Projectile trail
struct ProjectileTrail {
    segments: Vec<TrailSegment>,
    max_segments: i32,
    segment_lifetime: f64,
    color: Color,
}

struct TrailSegment {
    position: Vec3,
    age: f64,
}

// Beam effect (for laser weapons)
struct BeamEffect {
    id: i32,
    start_position: Vec3,
    end_position: Vec3,
    width: f64,
    color: Color,
    intensity: f64,
    age: f64,
    lifetime: f64,
}

// Explosion template
struct ExplosionTemplate {
    name: string,
    effect_type: EffectType,
    lifetime: f64,
    max_scale: f64,
    damage_radius: f64,
    particle_count: i32,
    light_intensity: f64,
    sound_name: string,
}

// Effects manager
struct EffectsManager {
    effects: Vec<Effect>,
    decals: Vec<Decal>,
    beams: Vec<BeamEffect>,
    trails: Vec<ProjectileTrail>,
    explosion_templates: Vec<ExplosionTemplate>,
    next_effect_id: i32,
    next_decal_id: i32,
    max_effects: i32,
    max_decals: i32,
}

// Helper structs
struct Vec3 {
    x: f64,
    y: f64,
    z: f64,
}

struct Color {
    r: f64,
    g: f64,
    b: f64,
    a: f64,
}

fn sqrt(x: f64): f64 {
    return x ** 0.5
}

// Tests
test "Effect: init" {
    let pos = Vec3::init(100.0, 0.0, 100.0)
    let effect = Effect::init(0, EffectType::EXPLOSION, pos)

    assert effect.id == 0
    assert effect.effect_type == EffectType::EXPLOSION
    assert effect.lifecycle == EffectLifecycle::SPAWNING
    assert effect.position.x == 100.0
}

test "Effect: lifecycle" {
    let pos = Vec3::init(0.0, 0.0, 0.0)
    let effect = Effect::init(0, EffectType::SMOKE, pos)
    effect.lifetime = 1.0

    assert effect.lifecycle == EffectLifecycle::SPAWNING

    effect.update(0.2)
    assert effect.lifecycle == EffectLifecycle::ACTIVE

    effect.update(0.7)
    assert effect.lifecycle == EffectLifecycle::FADING

    effect.update(0.2)
    assert effect.is_dead()
}

test "Effect: position update with velocity" {
    let pos = Vec3::init(0.0, 0.0, 0.0)
    let effect = Effect::init(0, EffectType::DEBRIS, pos)
    effect.velocity = Vec3::init(10.0, 5.0, 0.0)

    effect.update(1.0)

    assert effect.position.x == 10.0
    assert effect.position.y == 5.0
}

test "Effect: get life percentage" {
    let pos = Vec3::init(0.0, 0.0, 0.0)
    let effect = Effect::init(0, EffectType::FIRE, pos)
    effect.lifetime = 2.0

    effect.update(1.0)
    assert effect.get_life_percentage() == 50.0
}

test "Decal: init" {
    let pos = Vec3::init(50.0, 0.0, 50.0)
    let decal = Decal::init(0, pos, "scorch_mark.tga")

    assert decal.texture_name == "scorch_mark.tga"
    assert decal.alpha == 1.0
    assert !decal.is_expired()
}

test "Decal: fading" {
    let pos = Vec3::init(0.0, 0.0, 0.0)
    let decal = Decal::init(0, pos, "crater.tga")
    decal.lifetime = 10.0

    decal.update(7.0)
    assert decal.alpha == 1.0

    decal.update(2.0)
    assert decal.alpha < 1.0
}

test "Decal: expiration" {
    let pos = Vec3::init(0.0, 0.0, 0.0)
    let decal = Decal::init(0, pos, "test.tga")
    decal.lifetime = 1.0

    decal.update(1.5)
    assert decal.is_expired()
}

test "ProjectileTrail: init" {
    let trail = ProjectileTrail::init(10)

    assert trail.max_segments == 10
    assert trail.get_segment_count() == 0
}

test "ProjectileTrail: add segments" {
    let trail = ProjectileTrail::init(5)

    trail.add_segment(Vec3::init(0.0, 0.0, 0.0))
    trail.add_segment(Vec3::init(1.0, 0.0, 0.0))
    trail.add_segment(Vec3::init(2.0, 0.0, 0.0))

    assert trail.get_segment_count() == 3
}

test "ProjectileTrail: max segments limit" {
    let trail = ProjectileTrail::init(3)

    for i in 0..5 {
        trail.add_segment(Vec3::init(i as Float, 0.0, 0.0))
    }

    assert trail.get_segment_count() == 3  // Limited
}

test "ProjectileTrail: segment expiration" {
    let trail = ProjectileTrail::init(10)
    trail.segment_lifetime = 0.5

    trail.add_segment(Vec3::init(0.0, 0.0, 0.0))

    trail.update(0.6)
    assert trail.get_segment_count() == 0  // Expired
}

test "ProjectileTrail: clear" {
    let trail = ProjectileTrail::init(10)

    trail.add_segment(Vec3::init(0.0, 0.0, 0.0))
    trail.add_segment(Vec3::init(1.0, 0.0, 0.0))

    trail.clear()
    assert trail.get_segment_count() == 0
}

test "BeamEffect: init" {
    let start = Vec3::init(0.0, 0.0, 0.0)
    let end = Vec3::init(10.0, 0.0, 0.0)
    let beam = BeamEffect::init(0, start, end)

    assert beam.intensity == 1.0
    assert !beam.is_expired()
}

test "BeamEffect: length calculation" {
    let start = Vec3::init(0.0, 0.0, 0.0)
    let end = Vec3::init(10.0, 0.0, 0.0)
    let beam = BeamEffect::init(0, start, end)

    assert beam.get_length() == 10.0
}

test "BeamEffect: intensity fade" {
    let start = Vec3::init(0.0, 0.0, 0.0)
    let end = Vec3::init(10.0, 0.0, 0.0)
    let beam = BeamEffect::init(0, start, end)
    beam.lifetime = 1.0

    beam.update(0.5)
    assert beam.intensity == 0.5

    beam.update(0.6)
    assert beam.is_expired()
}

test "ExplosionTemplate: init" {
    let template = ExplosionTemplate::init("SmallExplosion")

    assert template.name == "SmallExplosion"
    assert template.effect_type == EffectType::EXPLOSION
    assert template.lifetime > 0.0
}

test "ExplosionTemplate: create effect" {
    let template = ExplosionTemplate::init("BigExplosion")
    template.lifetime = 2.0
    template.max_scale = 10.0

    let pos = Vec3::init(100.0, 0.0, 100.0)
    let effect = template.create_effect(5, pos)

    assert effect.id == 5
    assert effect.lifetime == 2.0
    assert effect.scale == 10.0
}

test "EffectsManager: init" {
    let manager = EffectsManager::init()

    assert manager.get_effect_count() == 0
    assert manager.get_decal_count() == 0
    assert manager.max_effects == 500
}

test "EffectsManager: spawn effect" {
    let manager = EffectsManager::init()

    let pos = Vec3::init(50.0, 0.0, 50.0)
    let id = manager.spawn_effect(EffectType::EXPLOSION, pos)

    assert id == 0
    assert manager.get_effect_count() == 1
}

test "EffectsManager: spawn decal" {
    let manager = EffectsManager::init()

    let pos = Vec3::init(100.0, 0.0, 100.0)
    let id = manager.spawn_decal(pos, "scorch.tga")

    assert id == 0
    assert manager.get_decal_count() == 1
}

test "EffectsManager: spawn beam" {
    let manager = EffectsManager::init()

    let start = Vec3::init(0.0, 0.0, 0.0)
    let end = Vec3::init(10.0, 0.0, 0.0)
    let id = manager.spawn_beam(start, end)

    assert id >= 0
    assert manager.get_beam_count() == 1
}

test "EffectsManager: create trail" {
    let manager = EffectsManager::init()

    let trail_id = manager.create_trail(10)

    assert trail_id == 0

    manager.update_trail(trail_id, Vec3::init(0.0, 0.0, 0.0))
    manager.update_trail(trail_id, Vec3::init(1.0, 0.0, 0.0))
}

test "EffectsManager: update removes dead effects" {
    let manager = EffectsManager::init()

    let pos = Vec3::init(0.0, 0.0, 0.0)
    manager.spawn_effect(EffectType::MUZZLE_FLASH, pos)

    assert manager.get_effect_count() == 1

    manager.update(2.0)  // Enough time to die
    assert manager.get_effect_count() == 0
}

test "EffectsManager: register and use template" {
    let manager = EffectsManager::init()

    let template = ExplosionTemplate::init("TestExplosion")
    template.lifetime = 5.0
    manager.register_explosion_template(template)

    let pos = Vec3::init(0.0, 0.0, 0.0)
    let id = manager.spawn_explosion("TestExplosion", pos)

    assert id >= 0
    assert manager.get_effect_count() == 1
}

test "EffectsManager: limit effects" {
    let manager = EffectsManager::init()
    manager.max_effects = 3

    let pos = Vec3::init(0.0, 0.0, 0.0)
    for i in 0..5 {
        manager.spawn_effect(EffectType::SMOKE, pos)
    }

    assert manager.get_effect_count() == 3  // Limited
}

test "EffectsManager: clear all" {
    let manager = EffectsManager::init()

    let pos = Vec3::init(0.0, 0.0, 0.0)
    manager.spawn_effect(EffectType::EXPLOSION, pos)
    manager.spawn_decal(pos, "test.tga")
    manager.spawn_beam(pos, Vec3::init(10.0, 0.0, 0.0))

    manager.clear_all()

    assert manager.get_effect_count() == 0
    assert manager.get_decal_count() == 0
    assert manager.get_beam_count() == 0
}
