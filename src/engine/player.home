// Player and Team system for C&C Generals Zero Hour
// Based on Thyme's player.h and team.h
// Written in Home language

// Player relationships
enum Relationship {
    NEUTRAL = 0,
    ENEMY = 1,
    ALLY = 2,
    SELF = 3,
}

// Player difficulty (for AI)
enum PlayerDifficulty {
    EASY = 0,
    MEDIUM = 1,
    HARD = 2,
    BRUTAL = 3,
}

// Player types
enum PlayerType {
    HUMAN = 0,
    COMPUTER = 1,
    OBSERVER = 2,
}

// Faction types
enum FactionType {
    USA = 0,
    CHINA = 1,
    GLA = 2,
}

// Team - Group of players with shared vision/alliance
struct Team {
    team_id: i32,
    name: string,
    players: Vec<i32>,  // Player IDs
    is_defeated: bool,
}

// Player - Represents a human or AI player
struct Player {
    player_id: i32,
    player_name: string,
    player_type: PlayerType,
    faction: FactionType,
    team_id: i32,
    difficulty: PlayerDifficulty,
    money: f64,
    power: i32,
    power_consumed: i32,
    max_unit_count: i32,
    current_unit_count: i32,
    upgrades_completed: i32,
    science_purchased: i32,
    general_points: i32,
    general_points_spent: i32,
    units_built: i32,
    units_lost: i32,
    units_killed: i32,
    buildings_built: i32,
    buildings_lost: i32,
    buildings_destroyed: i32,
    is_defeated: bool,
    is_observer: bool,
    has_surrendered: bool,
    color: i32,  // RGB color for this player
        player_name: string,
        player_type: PlayerType,
        faction: FactionType,
        team_id: i32
            player_id: player_id,
            player_name: player_name,
            player_type: player_type,
            faction: faction,
            team_id: team_id,
            difficulty: PlayerDifficulty::MEDIUM,
            money: 0.0,
            power: 0,
            power_consumed: 0,
            max_unit_count: 100,
            current_unit_count: 0,
            upgrades_completed: 0,
            science_purchased: 0,
            general_points: 0,
            general_points_spent: 0,
            units_built: 0,
            units_lost: 0,
            units_killed: 0,
            buildings_built: 0,
            buildings_lost: 0,
            buildings_destroyed: 0,
            is_defeated: false,
            is_observer: false,
            has_surrendered: false,
            color: 0xFFFFFF,
}

// PlayerManager - Manages all players in the game
struct PlayerManager {
    players: Vec<Player>,
    teams: Vec<Team>,
    local_player_id: i32,
}

// Tests
test "Player: init and basic properties" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)

    assert player.player_id == 0
    assert player.get_name() == "Player 1"
    assert player.is_human()
    assert !player.is_ai()
    assert player.get_faction() == FactionType::USA
}

test "Player: money management" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)

    player.add_money(5000.0)
    assert player.get_money() == 5000.0

    assert player.can_afford(1000.0)
    assert player.spend_money(1000.0)
    assert player.get_money() == 4000.0

    assert !player.can_afford(5000.0)
    assert !player.spend_money(5000.0)
    assert player.get_money() == 4000.0  // No change
}

test "Player: power management" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::CHINA, 0)

    player.add_power_generator(100)
    assert player.get_power() == 100
    assert player.get_power_available() == 100

    player.add_power_consumer(60)
    assert player.get_power_consumed() == 60
    assert player.get_power_available() == 40
    assert player.has_power()

    player.add_power_consumer(50)
    assert player.get_power_available() == -10
    assert !player.has_power()
}

test "Player: upgrades" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)

    assert !player.has_upgrade(5)
    player.add_upgrade(5)
    assert player.has_upgrade(5)
}

test "Player: science purchase" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::CHINA, 0)
    player.add_money(5000.0)

    assert !player.has_science(10)
    assert player.purchase_science(10, 2000.0)
    assert player.has_science(10)
    assert player.get_money() == 3000.0

    // Can't purchase twice
    assert !player.purchase_science(10, 2000.0)

    // Can't afford
    assert !player.purchase_science(11, 5000.0)
}

test "Player: unit limits" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::GLA, 0)
    player.max_unit_count = 5

    assert player.can_build_more_units()

    for i in 0..5 {
        player.on_unit_built()
    }

    assert !player.can_build_more_units()
}

test "Player: statistics" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)

    player.on_unit_built()
    player.on_unit_built()
    assert player.units_built == 2

    player.on_unit_destroyed(true)
    assert player.units_lost == 1

    player.on_unit_destroyed(false)
    assert player.units_killed == 1
}

test "Player: general points" {
    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)

    player.award_general_points(5)
    assert player.get_available_general_points() == 5

    assert player.spend_general_points(3)
    assert player.get_available_general_points() == 2

    assert !player.spend_general_points(5)
}

test "Team: player management" {
    let team = Team::init(0, "Team 1")

    team.add_player(0)
    team.add_player(1)

    assert team.has_player(0)
    assert team.has_player(1)
    assert !team.has_player(2)
    assert team.get_player_count() == 2

    team.remove_player(0)
    assert !team.has_player(0)
    assert team.get_player_count() == 1
}

test "PlayerManager: relationships" {
    let manager = PlayerManager::init()

    let player1 = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)
    let player2 = Player::init(1, "Player 2", PlayerType::HUMAN, FactionType::CHINA, 0)
    let player3 = Player::init(2, "Player 3", PlayerType::COMPUTER, FactionType::GLA, 1)

    manager.add_player(player1)
    manager.add_player(player2)
    manager.add_player(player3)

    // Same player
    assert manager.get_relationship(0, 0) == Relationship::SELF

    // Same team
    assert manager.get_relationship(0, 1) == Relationship::ALLY
    assert manager.are_allies(0, 1)

    // Different team
    assert manager.get_relationship(0, 2) == Relationship::ENEMY
    assert manager.are_enemies(0, 2)
}

test "PlayerManager: local player" {
    let manager = PlayerManager::init()

    let player = Player::init(0, "Player 1", PlayerType::HUMAN, FactionType::USA, 0)
    manager.add_player(player)

    manager.set_local_player(0)
    assert manager.is_local_player(0)

    let local = manager.get_local_player()?
    assert local.player_id == 0
}

test "PlayerManager: filtering players" {
    let manager = PlayerManager::init()

    let human1 = Player::init(0, "Human 1", PlayerType::HUMAN, FactionType::USA, 0)
    let human2 = Player::init(1, "Human 2", PlayerType::HUMAN, FactionType::CHINA, 0)
    let ai1 = Player::init(2, "AI 1", PlayerType::COMPUTER, FactionType::GLA, 1)

    manager.add_player(human1)
    manager.add_player(human2)
    manager.add_player(ai1)

    let humans = manager.get_human_players()
    assert humans.count() == 2

    let ais = manager.get_ai_players()
    assert ais.count() == 1

    human1.set_defeated(true)
    let alive = manager.get_alive_players()
    assert alive.count() == 2
}
