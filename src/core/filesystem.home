// C&C Generals Zero Hour - Home Port
// Core Filesystem System
//
// Original: FileSystem.cpp (Westwood Studios/EA)
// Ported to Home with modern async I/O support

import basics/allocator
import basics/io
import core/string

// File access modes
const FILE_READ: u32 = 0x00000001
const FILE_WRITE: u32 = 0x00000002
const FILE_READWRITE: u32 = FILE_READ | FILE_WRITE
const FILE_APPEND: u32 = 0x00000004
const FILE_CREATE: u32 = 0x00000008
const FILE_TRUNCATE: u32 = 0x00000010
const FILE_TEXT: u32 = 0x00000020
const FILE_BINARY: u32 = 0x00000040
const FILE_STREAMING: u32 = 0x00000100

// Seek modes
enum SeekMode {
    Start
    Current
    End
}

// File information
struct FileInfo {
    size: usize
    timestamp: i64
    is_directory: bool
    is_archive: bool
}

// File handle abstraction
struct File {
    path: string
    access_mode: u32
    is_open: bool
    position: usize
    size: usize
}

// Directory entry for wildcard searches
struct DirectoryEntry {
    name: string
    is_directory: bool
    size: usize
}

// Filesystem abstraction (supports local files + archives)
struct FileSystem {
    allocator: Allocator
    local_path: string
    file_cache: FileExistCache
}

// File existence cache (thread-safe)
struct FileExistCache {
    capacity: usize
    count: usize
    allocator: Allocator
}

struct FileExistEntry {
    path: string
    exists: bool
}

// Forward declaration for archive support
struct ArchiveFile {
}

// Global filesystem instance
var g_filesystem: ?FileSystem = null

export fn init_filesystem(allocator: Allocator, base_path: string) {
    g_filesystem = FileSystem.init(allocator, base_path)
}

export fn shutdown_filesystem() {
    if (g_filesystem) {
        g_filesystem.?.deinit()
        g_filesystem = null
    }
}

export fn open_file(path: string, mode: u32): ?File {
    if (g_filesystem) {
        return g_filesystem.?.open_file(path, mode)
    }
    return null
}

export fn file_exists(path: string): bool {
    if (g_filesystem) {
        return g_filesystem.?.file_exists(path)
    }
    return false
}
