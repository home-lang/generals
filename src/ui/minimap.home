// C&C Generals Zero Hour - Home Port
// Minimap System
//
// Original: Radar.cpp, RadarDisplay.cpp (Westwood Studios/EA)
// Ported to Home with real-time tactical overview

import basics/allocator
import engine/math
import engine/ecs
import game/unit
import game/building
import ui/ui_framework

// Minimap constants
const MINIMAP_WIDTH: usize = 180
const MINIMAP_HEIGHT: usize = 160
const MINIMAP_SCALE: f32 = 0.1  // World units to minimap pixels

// Minimap icon types
enum MinimapIconType {
    Infantry
    Vehicle
    Aircraft
    Building
    Resource
    Rally
    Ping
}

// Minimap icon
struct MinimapIcon {
    icon_type: MinimapIconType
    position: Vec2
    color: Color
    size: u8
    team: u8
    is_visible: bool
}

// Minimap display
struct Minimap {
    map_width: f32
    map_height: f32
    pixels_per_world_unit: f32
    buffer_width: usize
    buffer_height: usize
    terrain_texture_id: u32
    needs_terrain_update: bool
    icon_count: usize
    camera_rect: Rect
    camera_position: Vec3
    camera_zoom: f32
    is_dragging: bool
    last_click_pos: Vec2
    show_terrain: bool
    show_shroud: bool  // Fog of war
    show_units: bool
    show_buildings: bool
    allocator: Allocator
}

// Input handler for minimap
fn minimap_input_handler(window: *Window, msg: WindowMessage, data1: u32, data2: u32): bool {
    let minimap = @ptrCast(*Minimap, window.user_data)

    match msg {
        WindowMessage.LeftDown => {
            // Get mouse position relative to minimap window
            let mouse_x = @intCast(i32, data1) - window.screen_rect.x
            let mouse_y = @intCast(i32, data2) - window.screen_rect.y

            minimap.handle_click(mouse_x, mouse_y)
            minimap.is_dragging = true
            return true
        }
        WindowMessage.LeftUp => {
            minimap.is_dragging = false
            return true
        }
        WindowMessage.MousePos => {
            if (minimap.is_dragging) {
                let mouse_x = @intCast(i32, data1) - window.screen_rect.x
                let mouse_y = @intCast(i32, data2) - window.screen_rect.y
                minimap.handle_click(mouse_x, mouse_y)
            }
            return true
        }
        WindowMessage.RightDown => {
            let mouse_x = @intCast(i32, data1) - window.screen_rect.x
            let mouse_y = @intCast(i32, data2) - window.screen_rect.y
            minimap.handle_right_click(mouse_x, mouse_y)
            return true
        }
        _ => {}
    }

    return false
}

// Draw handler for minimap
fn minimap_draw_handler(window: *Window) {
    let minimap = @ptrCast(*Minimap, window.user_data)
    minimap.render()

    // TODO: Blit pixel_buffer to screen at window position
}

// Helper functions

fn get_team_color(team: u8): Color {
    match team {
        0 => Color.init(1.0, 0.0, 0.0, 1.0)    // Red
        1 => Color.init(0.0, 0.0, 1.0, 1.0)    // Blue
        2 => Color.init(0.0, 1.0, 0.0, 1.0)    // Green
        3 => Color.init(1.0, 1.0, 0.0, 1.0)    // Yellow
        4 => Color.init(1.0, 0.5, 0.0, 1.0)    // Orange
        5 => Color.init(0.5, 0.0, 0.5, 1.0)    // Purple
        6 => Color.init(0.0, 1.0, 1.0, 1.0)    // Cyan
        7 => Color.init(1.0, 0.5, 0.5, 1.0)    // Pink
        _ => Color.init(0.5, 0.5, 0.5, 1.0)    // Gray
    }
}

fn move_camera_to(world_x: f32, world_z: f32) {
    // TODO: Update camera position in game
}

// Vector2 helper
struct Vec2 {
    x: f32
    y: f32
}

// Global minimap
var g_minimap: ?Minimap = null

export fn init_minimap(allocator: Allocator, window: *Window, map_width: f32, map_height: f32) {
    g_minimap = Minimap.init(allocator, window, map_width, map_height)
}

export fn update_minimap(delta_time: f32, camera_pos: Vec3, camera_zoom: f32) {
    if (g_minimap) {
        g_minimap.?.update(delta_time, camera_pos, camera_zoom)
    }
}

export fn minimap_add_ping(world_x: f32, world_z: f32) {
    if (g_minimap) {
        g_minimap.?.add_ping(world_x, world_z)
    }
}

export fn shutdown_minimap() {
    if (g_minimap) {
        g_minimap.?.deinit()
        g_minimap = null
    }
}
