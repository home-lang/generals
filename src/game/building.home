// C&C Generals Zero Hour - Home Port
// Building System
//
// Original: Structure.cpp, ProductionUpdate.cpp (Westwood Studios/EA)
// Ported to Home with modern RTS building mechanics

import basics/allocator
import engine/ecs
import engine/math
import game/unit

// Building types
enum BuildingType {
    // USA Buildings
    Command_Center
    Supply_Center
    Barracks
    War_Factory
    Airfield
    Supply_Drop_Zone
    Patriot_Missile
    Fire_Base
    Strategy_Center
    Particle_Cannon

    // China Buildings
    Command_Bunker
    Supply_Center_China
    Barracks_China
    War_Factory_China
    Airfield_China
    Propaganda_Center
    Gattling_Cannon
    Bunker
    Nuke_Cannon_Building
    Nuclear_Missile

    // GLA Buildings
    Command_Tent
    Supply_Stash
    Barracks_GLA
    Arms_Dealer
    Black_Market
    Palace
    Tunnel_Network
    Stinger_Site
    SCUD_Storm
}

// Building state
enum BuildingState {
    Placing         // Being placed by player
    Constructing    // Under construction
    Active          // Fully built and operational
    Damaged         // Damaged but operational
    Disabled        // Severely damaged, not operational
    Destroyed       // Destroyed
    Selling         // Being sold
}

// Production queue item
struct ProductionItem {
    unit_type: UnitType
    progress: f32  // 0.0 to 1.0
    build_time: f32
    cost: u32
    is_paused: bool
}

// Building definition
struct BuildingDefinition {
    type: BuildingType
    name: string
    max_health: f32
    armor: f32
    build_cost: u32
    build_time: f32
    width: f32
    height: f32
    can_place_on_water: bool
    requires_power: bool
    power_production: i32
    power_consumption: i32
    can_produce_units: bool
    production_queue_size: usize
    producible_count: usize
    has_weapon: bool
    weapon_range: f32
    weapon_damage: f32
    weapon_fire_rate: f32
    provides_tech: bool
    tech_unlock: string
    garrison_slots: u32
    model_name: string
    build_animation: string
}

// Building instance
struct Building {
    entity: Entity
    state: BuildingState
    health: f32
    construction_progress: f32  // 0.0 to 1.0
    is_powered: bool
    is_operational: bool
    position: Vec3
    rotation: f32  // Rotation in radians
    footprint: BoxCollider
    queue_count: usize
    is_producing: bool
    time_until_next_fire: f32
    garrison_count: usize
    player_id: u32
    team_id: u32
}

// Building manager
struct BuildingManager {
    building_count: usize
    definition_count: usize
    allocator: Allocator
}

// Global building manager
var g_building_manager: ?BuildingManager = null

export fn init_building_manager(allocator: Allocator) {
    g_building_manager = BuildingManager.init(allocator)

    // Register default building definitions
    register_default_buildings()
}

export fn shutdown_building_manager() {
    if (g_building_manager) {
        g_building_manager.?.deinit()
        g_building_manager = null
    }
}

export fn create_building(type: BuildingType, position: Vec3, player_id: u32): ?Entity {
    if (g_building_manager) {
        let world = get_world()
        if (world) {
            return g_building_manager.?.create_building(type, position, player_id, world.?)
        }
    }
    return null
}

export fn update_buildings(delta_time: f32) {
    if (g_building_manager) {
        g_building_manager.?.update(delta_time)
    }
}

fn register_default_buildings() {
    if (!g_building_manager) {
        return
    }

    // USA Command Center
    let mut command = BuildingDefinition.init()
    command.type = BuildingType.Command_Center
    command.name = "Command Center"
    command.max_health = 5000.0
    command.armor = 200.0
    command.build_cost = 2000
    command.build_time = 60.0
    command.power_production = 5
    command.model_name = "usa_command"
    g_building_manager.?.register_definition(command)

    // USA Barracks
    let mut barracks = BuildingDefinition.init()
    barracks.type = BuildingType.Barracks
    barracks.name = "Barracks"
    barracks.max_health = 2000.0
    barracks.armor = 100.0
    barracks.build_cost = 500
    barracks.build_time = 20.0
    barracks.requires_power = true
    barracks.power_consumption = 1
    barracks.can_produce_units = true
    barracks.production_queue_size = 5
    // barracks.producible_units = [UnitType.Ranger, UnitType.Missile_Defender]
    barracks.model_name = "usa_barracks"
    g_building_manager.?.register_definition(barracks)

    // TODO: Add more building definitions
}
