// C&C Generals Zero Hour - Home Port
// Mission Objectives System
//
// Original: Part of ScriptEngine and UI system (EA Games)
// Ported to Home with EA's objectives tracking
//
// Objectives in C&C Generals:
// - Primary objectives (must complete to win)
// - Secondary objectives (optional, bonus points)
// - Hidden objectives (revealed when triggered)
// - States: Pending, Active, Completed, Failed
//
// Example objective definition:
// ```
// Objective DefendBase
//   Type = Primary
//   Description = "OBJECTIVE:DefendBase"
//   IsHidden = No
//   TriggerScript = "StartDefense"
//   CompleteCondition = Counter 'EnemiesDestroyed' >= 20
//   FailCondition = Unit 'CommandCenter' Dead
// End
// ```

import basics/allocator
import basics/string

const MAX_OBJECTIVES: u32 = 32
const MAX_OBJECTIVE_DESCRIPTION_LENGTH: u32 = 256

// Objective type
enum ObjectiveType {
    Primary     // Must complete to win mission
    Secondary   // Optional bonus objective
    Hidden      // Not shown until revealed
}

// Objective status
enum ObjectiveStatus {
    Pending     // Not yet started
    Active      // Currently active
    Completed   // Successfully completed
    Failed      // Failed (only matters for primary objectives)
    Cancelled   // Objective no longer relevant
}

// Mission objective
struct Objective {
    id: string                      // Unique identifier
    objective_type: ObjectiveType
    status: ObjectiveStatus
    description: string             // Text shown to player (or localization key)
    short_description: string       // Brief version for HUD
    is_hidden: bool                 // Hidden until revealed
    trigger_script: string          // Script that activates this objective
    complete_condition: string      // Condition to check for completion
    fail_condition: string          // Condition that fails objective
    current_count: i32              // For "kill 10 tanks" style objectives
    target_count: i32               // Target to reach
    rank_points: i32                // Points awarded on completion
    bonus_money: i32                // Money bonus on completion
    start_time: i32                 // Mission time when activated (seconds)
    complete_time: i32              // Mission time when completed (seconds)
    time_limit: i32                 // Time limit in seconds (0 = no limit)
}

// Objective manager
struct ObjectiveManager {
    objective_count: u32
    mission_time_seconds: i32
    all_primary_complete: bool
    any_primary_failed: bool
    allocator: Allocator
}

// Global objective manager
var g_objective_manager: ?ObjectiveManager = null

export fn init_objective_manager(allocator: Allocator) {
    g_objective_manager = ObjectiveManager.init(allocator)
}

export fn add_objective(objective: Objective): bool {
    if (!g_objective_manager) {
        return false
    }

    return g_objective_manager.?.add_objective(objective)
}

export fn activate_objective(id: string) {
    if (!g_objective_manager) {
        return
    }

    g_objective_manager.?.activate_objective(id)
}

export fn complete_objective(id: string) {
    if (!g_objective_manager) {
        return
    }

    g_objective_manager.?.complete_objective(id)
}

export fn fail_objective(id: string) {
    if (!g_objective_manager) {
        return
    }

    g_objective_manager.?.fail_objective(id)
}

export fn update_objective_progress(id: string, current: i32) {
    if (!g_objective_manager) {
        return
    }

    g_objective_manager.?.update_objective_progress(id, current)
}

export fn update_objectives(delta_time: f32) {
    if (!g_objective_manager) {
        return
    }

    g_objective_manager.?.update(delta_time)
}

export fn is_mission_victory(): bool {
    if (!g_objective_manager) {
        return false
    }

    return g_objective_manager.?.all_primary_complete
}

export fn is_mission_defeat(): bool {
    if (!g_objective_manager) {
        return false
    }

    return g_objective_manager.?.any_primary_failed
}

export fn shutdown_objective_manager() {
    g_objective_manager = null
}

fn get_global_allocator(): Allocator {
    // TODO: Return global allocator
    return Allocator {}
}
